<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceOn - ê°€ë³€í˜• ë§¤ì¥ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        
        /* í™”ë©´ ì „í™˜ìš© ìŠ¤íƒ€ì¼ */
        .screen { display: none; }
        .active { display: block; }

        /* 1. ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .login-box { 
            width: 300px; margin: 100px auto; background: white; padding: 30px; 
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; 
        }
        .login-input { width: 90%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .btn-login { width: 100%; padding: 10px; background: #0076BE; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* 2. ê³µí†µ ë ˆì´ì•„ì›ƒ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .container { display: flex; gap: 20px; }
        .sidebar { width: 320px; background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd; height: fit-content; }
        .map-area { flex: 1; background: white; padding: 30px; border-radius: 10px; border: 1px solid #ddd; min-height: 600px; text-align: center; }

        /* ë²„íŠ¼ ë° ì…ë ¥ ìŠ¤íƒ€ì¼ */
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-blue { background-color: #3498db; }
        .btn-green { background-color: #27ae60; }
        .btn-red { background-color: #e74c3c; }
        .btn-gray { background-color: #7f8c8d; }
        
        .input-full { width: 92%; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* ë§µ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .tbl-map { margin: 0 auto; border-spacing: 5px; border-collapse: separate; }
        .cell-btn { 
            width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 12px; border-radius: 8px; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s;
            flex-direction: column; line-height: 1.4;
        }
        .cell-btn:hover { transform: scale(1.05); }
        .cell-empty { background-color: #ecf0f1; color: #ccc; font-size: 20px; }
        
        /* ì‚¬ìš©ì ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .tag-area { text-align: center; margin-bottom: 20px; }
        .btn-tag { background: white; border: 1px solid #0076BE; color: #0076BE; padding: 5px 15px; border-radius: 20px; margin: 5px; cursor: pointer; }
        .btn-tag.active { background: #0076BE; color: white; }
        
        .highlight { border: 4px solid #f1c40f; transform: scale(1.1); z-index: 10; }
        .dimmed { opacity: 0.2; pointer-events: none; }
        .occupied { border: 4px solid #e74c3c; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .room-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="login-box">
            <h2 style="color:#0076BE;">SpaceOn</h2>
            <p style="color:#666; font-size:12px;">ê°€ë³€í˜• ë§¤ì¥ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
            <input type="text" id="loginID" class="login-input" placeholder="ì•„ì´ë”” (admin ë˜ëŠ” user)">
            <input type="password" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì•„ë¬´ê±°ë‚˜)">
            <button class="btn-login" onclick="login()">ë¡œê·¸ì¸</button>
            <p style="margin-top:10px; font-size:12px; color:#999;">* admin ì…ë ¥ ì‹œ ê´€ë¦¬ìëª¨ë“œ<br>* ê·¸ ì™¸ ì…ë ¥ ì‹œ ì‚¬ìš©ìëª¨ë“œ</p>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div class="header">
            <h3>ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ (Map Editor)</h3>
            <button class="btn btn-gray" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div class="container">
            <div class="sidebar">
                <h4>1. ë§µ í¬ê¸°</h4>
                ê°€ë¡œ <input type="number" id="mapRows" value="4" style="width:40px;"> 
                ì„¸ë¡œ <input type="number" id="mapCols" value="5" style="width:40px;">
                <button class="btn btn-blue" onclick="resizeMap()">ì ìš©</button>
                <hr>
                <h4>2. ë°© ì¢…ë¥˜ ì¶”ê°€</h4>
                <input type="text" id="newTypeName" class="input-full" placeholder="ì´ë¦„ (ì˜ˆ: ì»¤í”Œì„)">
                <input type="number" id="newTypePrice" class="input-full" placeholder="ê°€ê²© (3000)">
                <input type="text" id="newTypeTags" class="input-full" placeholder="#íƒœê·¸ (#ì»¤í”Œ #ê²Œì„)">
                ìƒ‰ìƒ <input type="color" id="newTypeColor" value="#3498db">
                <button class="btn btn-green" style="width:100%; margin-top:5px;" onclick="addRoomType()">ì¶”ê°€</button>
                
                <div id="typeList" style="margin-top:15px; max-height:200px; overflow-y:auto;">
                    </div>

                <hr>
                <h4>3. ë°°ì¹˜ ë„êµ¬ (ì„ íƒ í›„ ë§µ í´ë¦­)</h4>
                <div id="toolList">
                    </div>
            </div>
            <div class="map-area">
                <table class="tbl-map" id="adminMapGrid"></table>
            </div>
        </div>
    </div>

    <div id="screen-user" class="screen">
        <div class="header">
            <h3>ğŸ“º ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ (ì˜ˆì•½ ì‹œìŠ¤í…œ)</h3>
            <button class="btn btn-gray" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        
        <div class="tag-area" id="tagButtons">
            </div>

        <div class="map-area" style="background-color:#2c3e50;">
            <table class="tbl-map" id="userMapGrid"></table>
        </div>
    </div>

    <script>
        // --- ë°ì´í„° (DB ëŒ€ìš©) ---
        let mapConfig = { rows: 4, cols: 5 };
        let roomTypes = [
            { id: 1, name: 'ì§€ìš°ê°œ', price: 0, color: '#ecf0f1', tags: '' },
            { id: 2, name: 'ë²½', price: 0, color: '#34495e', tags: '' }
        ];
        let mapData = []; // {x, y, typeId, status, startTime}

        // --- ì´ˆê¸°í™” ---
        window.onload = function() {
            if(localStorage.getItem('spaceOn_types')) {
                roomTypes = JSON.parse(localStorage.getItem('spaceOn_types'));
                mapData = JSON.parse(localStorage.getItem('spaceOn_map'));
                mapConfig = JSON.parse(localStorage.getItem('spaceOn_config'));
            } else {
                // ì´ˆê¸° ë°ì´í„° ìƒì„±
                initMapData();
            }
            renderTypes();
        };

        function initMapData() {
            mapData = [];
            for(let r=0; r<mapConfig.rows; r++) {
                for(let c=0; c<mapConfig.cols; c++) {
                    mapData.push({ x:r, y:c, typeId: 1, status: 'Empty', startTime: null }); // 1=ì§€ìš°ê°œ
                }
            }
            saveData();
        }

        function saveData() {
            localStorage.setItem('spaceOn_types', JSON.stringify(roomTypes));
            localStorage.setItem('spaceOn_map', JSON.stringify(mapData));
            localStorage.setItem('spaceOn_config', JSON.stringify(mapConfig));
        }

        // --- 1. ë¡œê·¸ì¸ ë¡œì§ ---
        function login() {
            const id = document.getElementById('loginID').value;
            document.getElementById('screen-login').classList.remove('active');
            if(id === 'admin') {
                document.getElementById('screen-admin').classList.add('active');
                renderAdminMap();
                renderTypes();
            } else {
                document.getElementById('screen-user').classList.add('active');
                renderUserMap();
                renderTags();
            }
        }
        function logout() {
            location.reload();
        }

        // --- 2. ê´€ë¦¬ì ë¡œì§ ---
        function resizeMap() {
            mapConfig.rows = parseInt(document.getElementById('mapRows').value);
            mapConfig.cols = parseInt(document.getElementById('mapCols').value);
            // ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ë©´ì„œ í¬ê¸° ë³€ê²½ì€ ë³µì¡í•˜ë¯€ë¡œ ì´ˆê¸°í™” (ë°ëª¨ìš©)
            if(confirm('ë§µ í¬ê¸°ë¥¼ ë³€ê²½í•˜ë©´ ë°°ì¹˜ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?')) {
                initMapData();
                renderAdminMap();
            }
        }

        function addRoomType() {
            const name = document.getElementById('newTypeName').value;
            const price = document.getElementById('newTypePrice').value;
            const tags = document.getElementById('newTypeTags').value;
            const color = document.getElementById('newTypeColor').value;
            
            if(!name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');

            roomTypes.push({ id: Date.now(), name, price, color, tags });
            saveData();
            renderTypes();
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('newTypeName').value = '';
            document.getElementById('newTypeTags').value = '';
        }

        function renderTypes() {
            // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
            const list = document.getElementById('typeList');
            list.innerHTML = roomTypes.filter(t => t.id > 2).map(t => 
                `<div class="room-list-item">
                    <span><span style="color:${t.color}">â– </span> ${t.name} (${t.price}ì›)</span>
                    <button class="btn btn-red" style="font-size:10px; padding:2px 5px;" onclick="deleteType(${t.id})">ì‚­ì œ</button>
                </div>`
            ).join('');

            // ë¼ë””ì˜¤ ë²„íŠ¼ ë Œë”ë§
            const tools = document.getElementById('toolList');
            tools.innerHTML = roomTypes.map((t, idx) => 
                `<div><input type="radio" name="tool" value="${t.id}" ${idx===0?'checked':''}> ${t.name}</div>`
            ).join('');
        }

        function deleteType(id) {
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë°°ì¹˜ëœ ë°©ë„ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
                roomTypes = roomTypes.filter(t => t.id !== id);
                // ë§µì— ë°°ì¹˜ëœ ê²ƒë„ ì§€ìš°ê°œë¡œ ë³€ê²½
                mapData.forEach(cell => { if(cell.typeId === id) cell.typeId = 1; });
                saveData();
                renderTypes();
                renderAdminMap();
            }
        }

        function renderAdminMap() {
            const tbl = document.getElementById('adminMapGrid');
            tbl.innerHTML = '';
            for(let r=0; r<mapConfig.rows; r++) {
                let tr = document.createElement('tr');
                for(let c=0; c<mapConfig.cols; c++) {
                    let td = document.createElement('td');
                    let cell = mapData.find(d => d.x === r && d.y === c);
                    let type = roomTypes.find(t => t.id === cell.typeId) || roomTypes[0];
                    
                    td.className = 'cell-btn';
                    if(type.id === 1) td.classList.add('cell-empty');
                    else td.style.backgroundColor = type.color;
                    
                    td.innerHTML = type.id === 1 ? '+' : type.name;
                    td.onclick = () => onAdminCellClick(r, c);
                    tr.appendChild(td);
                }
                tbl.appendChild(tr);
            }
        }

        function onAdminCellClick(r, c) {
            const selected = document.querySelector('input[name="tool"]:checked');
            if(!selected) return;
            const typeId = parseInt(selected.value);
            
            // ë°ì´í„° ì—…ë°ì´íŠ¸
            let cell = mapData.find(d => d.x === r && d.y === c);
            cell.typeId = typeId;
            saveData();
            renderAdminMap();
        }

        // --- 3. ì‚¬ìš©ì ë¡œì§ ---
        function renderTags() {
            // ë°°ì¹˜ëœ ë°©ë“¤ì˜ íƒœê·¸ë§Œ ìˆ˜ì§‘
            let tags = new Set();
            mapData.forEach(cell => {
                let type = roomTypes.find(t => t.id === cell.typeId);
                if(type && type.tags) {
                    type.tags.split(' ').forEach(tag => {
                        if(tag.startsWith('#')) tags.add(tag);
                    });
                }
            });

            const area = document.getElementById('tagButtons');
            area.innerHTML = `<button class="btn-tag" onclick="filterMap(null)">ì „ì²´ë³´ê¸°</button>`;
            tags.forEach(tag => {
                area.innerHTML += `<button class="btn-tag" onclick="filterMap('${tag}')">${tag}</button>`;
            });
        }

        function renderUserMap(filterTag = null) {
            const tbl = document.getElementById('userMapGrid');
            tbl.innerHTML = '';
            for(let r=0; r<mapConfig.rows; r++) {
                let tr = document.createElement('tr');
                for(let c=0; c<mapConfig.cols; c++) {
                    let td = document.createElement('td');
                    let cell = mapData.find(d => d.x === r && d.y === c);
                    let type = roomTypes.find(t => t.id === cell.typeId);
                    
                    td.className = 'cell-btn';
                    
                    // ì§€ìš°ê°œë‚˜ ë²½ ì²˜ë¦¬
                    if(type.id === 1) { 
                        td.style.visibility = 'hidden'; 
                    } else if(type.id === 2) { 
                        td.style.backgroundColor = type.color; 
                        td.style.opacity = 0.3; 
                    } else {
                        // ì¼ë°˜ ë°©
                        td.style.backgroundColor = type.color;
                        if(cell.status === 'Occupied') {
                            td.innerHTML = `${type.name}<br>â›” ì‚¬ìš©ì¤‘`;
                            td.classList.add('occupied');
                        } else {
                            td.innerHTML = `${type.name}<br>â­• ëŒ€ê¸°`;
                        }
                        
                        // í•„í„°ë§
                        if(filterTag) {
                            if(type.tags && type.tags.includes(filterTag)) td.classList.add('highlight');
                            else td.classList.add('dimmed');
                        }

                        td.onclick = () => onUserCellClick(cell, type);
                    }
                    tr.appendChild(td);
                }
                tbl.appendChild(tr);
            }
        }

        function filterMap(tag) {
            renderUserMap(tag);
        }

        function onUserCellClick(cell, type) {
            if(type.id <= 2) return; // ì§€ìš°ê°œ, ë²½ ë¬´ì‹œ

            if(cell.status === 'Empty') {
                if(confirm(`[${type.name}]\nê°€ê²©: ì‹œê°„ë‹¹ ${type.price}ì›\n\nì…ì‹¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    cell.status = 'Occupied';
                    cell.startTime = Date.now();
                    saveData();
                    renderUserMap();
                }
            } else {
                // í‡´ì‹¤ (ê°€ìƒ ê²°ì œ)
                let minutes = Math.floor((Date.now() - cell.startTime) / 60000); // ë¶„ ë‹¨ìœ„
                if(minutes < 1) minutes = 1; // ìµœì†Œ 1ë¶„
                let cost = Math.floor((type.price / 60) * minutes);
                
                if(confirm(`[í‡´ì‹¤ ë° ê²°ì œ]\nì´ìš© ì‹œê°„: ${minutes}ë¶„\nê²°ì œ ê¸ˆì•¡: ${cost}ì›\n\nê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    cell.status = 'Empty';
                    cell.startTime = null;
                    saveData();
                    alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    renderUserMap();
                }
            }
        }
    </script>
</body>
</html>