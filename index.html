<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceOn - ê°€ë³€í˜• ë§¤ì¥ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        /* [ë³´ë‚´ì£¼ì‹  Login.aspx ìŠ¤íƒ€ì¼ ì›ë³¸ ë°˜ì˜] */
        body { background-color: #f5f5f5; font-family: 'Malgun Gothic'; text-align: center; margin: 0; }
        
        /* í™”ë©´ ì „í™˜ìš© ìœ í‹¸ë¦¬í‹° */
        .screen { display: none; height: 100vh; overflow: auto; }
        .active { display: block; }

        /* 1. ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .login-box { background: white; width: 350px; margin: 100px auto; padding: 40px; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .input-txt { width: 90%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .btn-login { width: 98%; padding: 12px; background-color: #0076BE; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; margin-bottom: 10px; }
        .btn-join { width: 98%; padding: 12px; background-color: #7f8c8d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; }
        
        /* 2. ë©”ì¸ ì‹œìŠ¤í…œ ê³µí†µ ë ˆì´ì•„ì›ƒ */
        .main-container { display: flex; padding: 20px; gap: 20px; text-align: left; max-width: 1200px; margin: 0 auto; }
        .sidebar { width: 320px; background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd; height: fit-content; }
        .map-area { flex: 1; background: white; padding: 30px; border-radius: 10px; border: 1px solid #ddd; min-height: 600px; text-align: center; display: flex; justify-content: center; align-items: center; }
        
        .header { background: white; padding: 15px 30px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; color: #0076BE; }

        /* ì…ë ¥ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .input-full { width: 95%; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .input-half { width: 60px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; font-size: 14px; }
        .btn-blue { background-color: #3498db; }
        .btn-green { background-color: #27ae60; }
        .btn-red { background-color: #e74c3c; }
        .btn-gray { background-color: #7f8c8d; }

        /* ë§µ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .tbl-map { border-spacing: 10px; border-collapse: separate; margin: auto; }
        .cell-btn { 
            width: 90px; height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 13px; border-radius: 10px; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; user-select: none;
        }
        .cell-btn:hover { transform: scale(1.05); }
        .cell-empty { background-color: #ecf0f1; color: #bbb; border: 1px dashed #ccc; box-shadow: none; font-size: 20px; }
        
        /* ì‚¬ìš©ì ìƒíƒœ ìŠ¤íƒ€ì¼ */
        .occupied { border: 4px solid #e74c3c; animation: pulse 1.5s infinite; position: relative; }
        .occupied::after { content: "â›” ì‚¬ìš©ì¤‘"; font-size: 11px; margin-top: 5px; display: block; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px; }
        .waiting { opacity: 0.9; }
        .waiting::after { content: "â­• ëŒ€ê¸°"; font-size: 11px; margin-top: 5px; display: block; background: rgba(0,0,0,0.1); padding: 2px 5px; border-radius: 4px; }

        @keyframes pulse { 0% { border-color: #e74c3c; } 50% { border-color: #c0392b; transform: scale(0.98); } 100% { border-color: #e74c3c; } }

        /* íƒœê·¸ í•„í„° ìŠ¤íƒ€ì¼ */
        .tag-area { margin-bottom: 20px; text-align: center; }
        .btn-tag { background: white; border: 1px solid #0076BE; color: #0076BE; padding: 6px 15px; border-radius: 20px; margin: 5px; cursor: pointer; transition: 0.2s; }
        .btn-tag:hover, .btn-tag.active { background: #0076BE; color: white; font-weight: bold; }
        .highlight { transform: scale(1.1); box-shadow: 0 0 15px #f1c40f; z-index: 10; border: 2px solid #f1c40f; }
        .dimmed { opacity: 0.15; filter: grayscale(100%); pointer-events: none; }

        /* ë°© ì¢…ë¥˜ ë¦¬ìŠ¤íŠ¸ */
        .type-item { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 8px; border-bottom: 1px solid #eee; margin-bottom: 5px; font-size: 13px; border-radius: 4px; }
        .color-box { display: inline-block; width: 15px; height: 15px; border-radius: 3px; margin-right: 5px; vertical-align: middle; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="login-box">
            <h2 style="color:#0076BE;">SpaceOn System</h2>
            <p style="color:#666; font-size:14px;">ë§¤ì¥ ê´€ë¦¬ ì‹œìŠ¤í…œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.</p>
            <br />
            <input type="text" id="txtID" class="input-txt" placeholder="ì•„ì´ë””">
            <input type="password" id="txtPW" class="input-txt" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <br /><br />
            <button class="btn-login" onclick="tryLogin()">ë¡œê·¸ì¸</button>
            <button class="btn-join" onclick="goJoin()">íšŒì›ê°€ì…</button>
            <br /><br />
            <p id="lblMsg" style="color:red; font-size:13px; min-height:20px;"></p>
            <p style="color:#999; font-size:12px; margin-top:20px;">* í¬íŠ¸í´ë¦¬ì˜¤ ë°ëª¨ìš© *<br>ID: <b>admin</b> (ê´€ë¦¬ì) / <b>user</b> (ì‚¬ìš©ì)</p>
        </div>
    </div>

    <div id="screen-join" class="screen">
        <div class="login-box">
            <h2 style="color:#7f8c8d;">íšŒì›ê°€ì…</h2>
            <p style="color:#666; font-size:14px;">SpaceOnì˜ ìƒˆë¡œìš´ ê°€ì¡±ì´ ë˜ì–´ì£¼ì„¸ìš”.</p>
            <br />
            <input type="text" class="input-txt" placeholder="ì‚¬ìš©í•  ì•„ì´ë””">
            <input type="password" class="input-txt" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <input type="text" class="input-txt" placeholder="ì´ë¦„">
            <br /><br />
            <button class="btn-login" style="background-color:#27ae60;" onclick="doJoin()">ê°€ì…í•˜ê¸°</button>
            <button class="btn-join" onclick="goLogin()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div class="header">
            <div>
                <h2>ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ (SpaceOn Admin)</h2>
                <span style="font-size:12px; color:#666;">ë§¤ì¥ êµ¬ì¡° í¸ì§‘ ë° ìš´ì˜ ê´€ë¦¬</span>
            </div>
            <div>
                <span id="adminName" style="margin-right:10px; font-weight:bold;">ê´€ë¦¬ìë‹˜</span>
                <button class="btn btn-gray" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        <div class="main-container">
            <div class="sidebar">
                <h4 style="color:#2c3e50;">1. ë§µ í¬ê¸° ì„¤ì •</h4>
                ê°€ë¡œ: <input type="number" id="mapRows" value="5" class="input-half"> 
                ì„¸ë¡œ: <input type="number" id="mapCols" value="5" class="input-half">
                <button class="btn btn-blue" style="float:right;" onclick="resizeMap()">ì ìš©</button>
                <div style="clear:both; margin-bottom:20px;"></div>
                <hr style="border:0; border-top:1px dashed #ccc;">

                <h4 style="color:#2c3e50;">2. ë°© ì¢…ë¥˜ ê´€ë¦¬</h4>
                <div style="background:#eee; padding:10px; border-radius:5px;">
                    <input type="text" id="newTypeName" class="input-full" placeholder="ì´ë¦„ (ì˜ˆ: ë„·í”Œë¦­ìŠ¤ë£¸)">
                    <input type="number" id="newTypePrice" class="input-full" placeholder="ê°€ê²© (ì˜ˆ: 3000)">
                    <input type="text" id="newTypeTags" class="input-full" placeholder="íƒœê·¸ (ì˜ˆ: #ì»¤í”Œ #ì˜í™”)">
                    <div style="margin-top:5px;">
                        ìƒ‰ìƒ: <input type="color" id="newTypeColor" value="#3498db" style="vertical-align:middle;">
                        <button class="btn btn-green" style="float:right; padding:5px 10px;" onclick="addRoomType()">ìƒì„±</button>
                    </div>
                </div>
                <div id="typeList" style="margin-top:10px; max-height:200px; overflow-y:auto;"></div>

                <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">

                <h4 style="color:#2c3e50;">3. ë°°ì¹˜ ë„êµ¬ (ì„ íƒ í›„ ë§µ í´ë¦­)</h4>
                <div id="toolList" style="font-size:14px;"></div>
                
                <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
                <h4 style="color:#e74c3c;">4. ìš´ì˜ ê´€ë¦¬</h4>
                <p style="font-size:12px; color:#666;">ì‚¬ìš© ì¤‘ì¸ ë°©ì„ í´ë¦­í•˜ë©´<br><b>[ê°•ì œ í‡´ì‹¤]</b> ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="map-area">
                <table class="tbl-map" id="adminMapGrid"></table>
            </div>
        </div>
    </div>

    <div id="screen-user" class="screen">
        <div class="header">
            <div>
                <h2>ğŸ“º SpaceOn ì‚¬ìš©ì í˜„í™©íŒ</h2>
                <span style="font-size:12px; color:#666;">ì‹¤ì‹œê°„ ì¢Œì„ í™•ì¸ ë° ì˜ˆì•½ ì‹œìŠ¤í…œ</span>
            </div>
            <div>
                <span id="userName" style="margin-right:10px; font-weight:bold;">ì‚¬ìš©ìë‹˜</span>
                <button class="btn btn-gray" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="main-container" style="display:block; text-align:center;">
            <div class="tag-area" id="tagButtons">
                </div>

            <div class="map-area" style="background-color:#2c3e50; display:inline-block; min-width:600px;">
                <table class="tbl-map" id="userMapGrid"></table>
            </div>
            <p style="color:#666; font-size:13px; margin-top:10px;">* ì›í•˜ëŠ” ë°©ì„ í´ë¦­í•˜ì—¬ ì…ì‹¤í•˜ì„¸ìš”. ë‚´ ë°©ì„ í´ë¦­í•˜ë©´ í‡´ì‹¤(ê²°ì œ)ë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        // --- [ë°ì´í„° ëª¨ë¸ (DB ëŒ€ìš©)] ---
        // ìƒˆë¡œê³ ì¹¨í•´ë„ ë°ì´í„°ê°€ ë‚ ì•„ê°€ì§€ ì•Šë„ë¡ localStorage ì‚¬ìš©
        const DB_KEY_CONFIG = 'spaceon_config';
        const DB_KEY_TYPES = 'spaceon_types';
        const DB_KEY_MAP = 'spaceon_map';

        let mapConfig = { rows: 5, cols: 5 };
        let roomTypes = [
            { id: 1, name: 'ì§€ìš°ê°œ', price: 0, color: '#ecf0f1', tags: '' },
            { id: 2, name: 'ë²½', price: 0, color: '#34495e', tags: '' }
        ];
        // ë§µ ë°ì´í„°: { x, y, typeId, status, startTime, ownerId }
        let mapData = []; 
        let currentUser = ''; // í˜„ì¬ ë¡œê·¸ì¸í•œ ID

        // --- [ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ] ---
        window.onload = function() {
            loadData();
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            if (mapData.length === 0) initMapData();
            renderTypes();
            // í™”ë©´ í¬ê¸°ì— ë§ê²Œ Admin Inputs ì„¸íŒ…
            document.getElementById('mapRows').value = mapConfig.rows;
            document.getElementById('mapCols').value = mapConfig.cols;
        };

        function loadData() {
            const storedConfig = localStorage.getItem(DB_KEY_CONFIG);
            const storedTypes = localStorage.getItem(DB_KEY_TYPES);
            const storedMap = localStorage.getItem(DB_KEY_MAP);

            if (storedConfig) mapConfig = JSON.parse(storedConfig);
            if (storedTypes) roomTypes = JSON.parse(storedTypes);
            if (storedMap) mapData = JSON.parse(storedMap);
        }

        function saveData() {
            localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(mapConfig));
            localStorage.setItem(DB_KEY_TYPES, JSON.stringify(roomTypes));
            localStorage.setItem(DB_KEY_MAP, JSON.stringify(mapData));
        }

        function initMapData() {
            mapData = [];
            for (let r = 0; r < mapConfig.rows; r++) {
                for (let c = 0; c < mapConfig.cols; c++) {
                    mapData.push({ x: r, y: c, typeId: 1, status: 'Empty', startTime: null, ownerId: null });
                }
            }
            saveData();
        }

        // --- [1. í™”ë©´ ì „í™˜ ë° ë¡œê·¸ì¸ ë¡œì§] ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function tryLogin() {
            const id = document.getElementById('txtID').value.trim();
            const pw = document.getElementById('txtPW').value;
            const msg = document.getElementById('lblMsg');

            if (!id) {
                msg.innerText = "ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }

            // ì‹œë®¬ë ˆì´ì…˜ ë¡œì§: adminì´ë©´ ê´€ë¦¬ì, ê·¸ì™¸ëŠ” ì‚¬ìš©ì
            currentUser = id;
            msg.innerText = "";
            
            if (id === 'admin') {
                document.getElementById('adminName').innerText = id + "ë‹˜";
                renderAdminMap();
                renderTypes();
                showScreen('screen-admin');
            } else {
                document.getElementById('userName').innerText = id + "ë‹˜";
                renderUserMap();
                renderTags();
                showScreen('screen-user');
            }
        }

        function logout() {
            currentUser = '';
            document.getElementById('txtID').value = '';
            document.getElementById('txtPW').value = '';
            showScreen('screen-login');
        }

        function goJoin() { showScreen('screen-join'); }
        function goLogin() { showScreen('screen-login'); }
        function doJoin() {
            alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n(ì‹œë®¬ë ˆì´ì…˜)');
            goLogin();
        }

        // --- [2. ê´€ë¦¬ì ê¸°ëŠ¥ (Map Editor)] ---
        function resizeMap() {
            const r = parseInt(document.getElementById('mapRows').value);
            const c = parseInt(document.getElementById('mapCols').value);
            if (confirm(`ë§µ í¬ê¸°ë¥¼ ${r}x${c}ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ë°°ì¹˜ëŠ” ì´ˆê¸°í™”ë©ë‹ˆë‹¤.`)) {
                mapConfig.rows = r;
                mapConfig.cols = c;
                initMapData(); // ë°ì´í„° ë¦¬ì…‹
                renderAdminMap();
            }
        }

        function addRoomType() {
            const name = document.getElementById('newTypeName').value;
            const price = document.getElementById('newTypePrice').value;
            const tags = document.getElementById('newTypeTags').value;
            const color = document.getElementById('newTypeColor').value;

            if (!name || !price) { alert('ì´ë¦„ê³¼ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            const newType = { id: Date.now(), name, price, color, tags };
            roomTypes.push(newType);
            saveData();
            
            // ì…ë ¥ì°½ ë¹„ìš°ê¸°
            document.getElementById('newTypeName').value = '';
            document.getElementById('newTypeTags').value = '';
            
            renderTypes();
        }

        function deleteType(id) {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në°°ì¹˜ëœ í•´ë‹¹ ë°©ë“¤ë„ ëª¨ë‘ ì§€ìš°ê°œë¡œ ë³€í•©ë‹ˆë‹¤.')) {
                roomTypes = roomTypes.filter(t => t.id !== id);
                // ë§µ ë°ì´í„°ì—ì„œë„ í•´ë‹¹ íƒ€ì… ì œê±°
                mapData.forEach(cell => { if (cell.typeId === id) cell.typeId = 1; });
                saveData();
                renderTypes();
                renderAdminMap();
            }
        }

        function renderTypes() {
            // 1. ê´€ë¦¬ììš© ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
            const list = document.getElementById('typeList');
            list.innerHTML = roomTypes.filter(t => t.id > 2).map(t => `
                <div class="type-item">
                    <span>
                        <span class="color-box" style="background:${t.color}"></span>
                        <b>${t.name}</b> (${t.price}ì›) <br>
                        <span style="color:#888; font-size:11px;">${t.tags}</span>
                    </span>
                    <button class="btn btn-red" style="padding:2px 6px; font-size:11px;" onclick="deleteType(${t.id})">ì‚­ì œ</button>
                </div>
            `).join('');

            // 2. ê´€ë¦¬ììš© ë°°ì¹˜ ë„êµ¬ (ë¼ë””ì˜¤ ë²„íŠ¼)
            const tools = document.getElementById('toolList');
            tools.innerHTML = roomTypes.map((t, idx) => `
                <div style="margin-bottom:5px;">
                    <label style="cursor:pointer;">
                        <input type="radio" name="tool" value="${t.id}" ${idx===0?'checked':''}>
                        <span class="color-box" style="background:${t.color}; width:12px; height:12px; border:1px solid #999;"></span>
                        ${t.name}
                    </label>
                </div>
            `).join('');
        }

        function renderAdminMap() {
            const tbl = document.getElementById('adminMapGrid');
            tbl.innerHTML = '';

            for (let r = 0; r < mapConfig.rows; r++) {
                let tr = document.createElement('tr');
                for (let c = 0; c < mapConfig.cols; c++) {
                    let td = document.createElement('td');
                    let cell = mapData.find(d => d.x === r && d.y === c);
                    let type = roomTypes.find(t => t.id === cell.typeId) || roomTypes[0];

                    td.className = 'cell-btn';
                    
                    if (type.id === 1) { // ì§€ìš°ê°œ(ë¹ˆê³µê°„)
                        td.classList.add('cell-empty');
                        td.innerText = '+';
                    } else {
                        td.style.backgroundColor = type.color;
                        td.innerText = type.name;
                        // ì‚¬ìš©ì¤‘ì´ë©´ í‘œì‹œ
                        if (cell.status === 'Occupied') {
                            td.innerHTML += "<br>â›”<br><small>ì‚¬ìš©ì¤‘</small>";
                        }
                    }

                    // í´ë¦­ ì‹œ ë°°ì¹˜ or ê°•ì œí‡´ì‹¤
                    td.onclick = () => onAdminCellClick(r, c, cell);
                    tr.appendChild(td);
                }
                tbl.appendChild(tr);
            }
        }

        function onAdminCellClick(r, c, cell) {
            // ë§Œì•½ ì‚¬ìš© ì¤‘ì¸ ë°©ì„ í´ë¦­í–ˆë‹¤ë©´ -> ê°•ì œ í‡´ì‹¤ ê¸°ëŠ¥
            if (cell.status === 'Occupied') {
                if (confirm(`[ê´€ë¦¬ì ê¶Œí•œ]\ní˜„ì¬ ${cell.ownerId}ë‹˜ì´ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.\nê°•ì œ í‡´ì‹¤ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    cell.status = 'Empty';
                    cell.startTime = null;
                    cell.ownerId = null;
                    saveData();
                    renderAdminMap();
                    alert('ê°•ì œ í‡´ì‹¤ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                return;
            }

            // ì¼ë°˜ ë°°ì¹˜ ë¡œì§
            const selectedTool = document.querySelector('input[name="tool"]:checked');
            if (selectedTool) {
                const typeId = parseInt(selectedTool.value);
                cell.typeId = typeId;
                // ë°°ì¹˜ ë°”ë€Œë©´ ìƒíƒœ ì´ˆê¸°í™”
                cell.status = 'Empty'; 
                cell.startTime = null;
                cell.ownerId = null;
                
                saveData();
                renderAdminMap();
            }
        }

        // --- [3. ì‚¬ìš©ì ê¸°ëŠ¥ (Dashboard)] ---
        function renderTags() {
            const tags = new Set();
            mapData.forEach(cell => {
                const type = roomTypes.find(t => t.id === cell.typeId);
                if (type && type.tags) {
                    type.tags.split(' ').forEach(tag => { if (tag.startsWith('#')) tags.add(tag); });
                }
            });

            const area = document.getElementById('tagButtons');
            area.innerHTML = `<button class="btn-tag active" onclick="filterMap(this, null)">ì „ì²´ë³´ê¸° ğŸ”„</button>`;
            tags.forEach(tag => {
                area.innerHTML += `<button class="btn-tag" onclick="filterMap(this, '${tag}')">${tag}</button>`;
            });
        }

        function filterMap(btn, tag) {
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ í™œì„±í™”
            document.querySelectorAll('.btn-tag').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            renderUserMap(tag);
        }

        function renderUserMap(filterTag = null) {
            const tbl = document.getElementById('userMapGrid');
            tbl.innerHTML = '';

            for (let r = 0; r < mapConfig.rows; r++) {
                let tr = document.createElement('tr');
                for (let c = 0; c < mapConfig.cols; c++) {
                    let td = document.createElement('td');
                    let cell = mapData.find(d => d.x === r && d.y === c);
                    let type = roomTypes.find(t => t.id === cell.typeId);

                    td.className = 'cell-btn';

                    // 1. ì§€ìš°ê°œ(1)ëŠ” ìˆ¨ê¹€, ë²½(2)ì€ ë¶ˆíˆ¬ëª…
                    if (type.id === 1) {
                        td.style.visibility = 'hidden';
                    } else if (type.id === 2) {
                        td.style.backgroundColor = type.color;
                        td.style.opacity = 0.3;
                        td.style.cursor = 'default';
                    } else {
                        // 2. ì¼ë°˜ ë°©
                        td.style.backgroundColor = type.color;
                        
                        // 3. ìƒíƒœ í‘œì‹œ
                        if (cell.status === 'Occupied') {
                            td.classList.add('occupied');
                            td.classList.remove('waiting');
                            // ë‚´ ë°©ì´ë©´ í‘œì‹œ
                            if (cell.ownerId === currentUser) {
                                td.innerHTML = `${type.name}<br>ğŸ‘¤ <b>ë‚˜ì˜ ë°©</b>`;
                            } else {
                                td.innerHTML = `${type.name}`; // ë‚¨ì˜ ë°©ì€ ë‚´ìš© ê°„ì†Œí™”
                            }
                        } else {
                            td.classList.add('waiting');
                            td.innerHTML = `${type.name}`;
                        }

                        // 4. íƒœê·¸ í•„í„°ë§ (Dimmed ì²˜ë¦¬)
                        if (filterTag) {
                            if (type.tags && type.tags.includes(filterTag)) {
                                td.classList.add('highlight');
                            } else {
                                td.classList.add('dimmed');
                            }
                        }

                        // í´ë¦­ ì´ë²¤íŠ¸
                        td.onclick = () => onUserCellClick(cell, type);
                    }
                    tr.appendChild(td);
                }
                tbl.appendChild(tr);
            }
        }

        function onUserCellClick(cell, type) {
            if (type.id <= 2) return; // ì§€ìš°ê°œ, ë²½ ë¬´ì‹œ

            // 1. ë¹ˆ ë°©ì¼ ë•Œ -> ì…ì‹¤
            if (cell.status === 'Empty') {
                const confirmMsg = `[${type.name}]\nê°€ê²©: ì‹œê°„ë‹¹ ${type.price}ì›\nì˜µì…˜: ${type.tags}\n\nì…ì‹¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                if (confirm(confirmMsg)) {
                    cell.status = 'Occupied';
                    cell.startTime = Date.now();
                    cell.ownerId = currentUser;
                    saveData();
                    renderUserMap();
                    alert('ì…ì‹¤ ì™„ë£Œ! ì¦ê±°ìš´ ì‹œê°„ ë˜ì„¸ìš”.');
                }
            } 
            // 2. ì‚¬ìš© ì¤‘ì¼ ë•Œ
            else {
                // ë‚´ ë°©ì¼ ë•Œ -> í‡´ì‹¤(ê²°ì œ)
                if (cell.ownerId === currentUser) {
                    const now = Date.now();
                    let minutes = Math.floor((now - cell.startTime) / 60000);
                    if (minutes < 1) minutes = 1; // ìµœì†Œ 1ë¶„ ìš”ê¸ˆ
                    
                    const cost = Math.floor((type.price / 60) * minutes);
                    
                    const payMsg = `[í‡´ì‹¤ ë° ê²°ì œ]\nì´ìš© ì‹œê°„: ${minutes}ë¶„\nê²°ì œ ê¸ˆì•¡: ${cost}ì›\n\nê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    if (confirm(payMsg)) {
                        cell.status = 'Empty';
                        cell.startTime = null;
                        cell.ownerId = null;
                        saveData();
                        renderUserMap();
                        alert(`ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (${cost}ì›)`);
                    }
                } 
                // ë‚¨ì˜ ë°©ì¼ ë•Œ -> ê±°ì ˆ
                else {
                    alert('â›” ë‹¤ë¥¸ ì†ë‹˜ì´ ì´ìš© ì¤‘ì¸ ë°©ì…ë‹ˆë‹¤.');
                }
            }
        }
    </script>
</body>
</html>
